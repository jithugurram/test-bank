pipeline {
  agent any

  environment {
    DOCKER_HUB_REPO = 'jithendragurram/bank'
    AWS_REGION = 'eu-west-2'
    K8S_CLUSTER_NAME = 'Jithu-bank'
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        git 'https://github.com/jithugurram/bank.git'
      }
    }

    stage('Build Image') {
      steps {
        sh "docker build -t ${DOCKER_HUB_REPO}:${IMAGE_TAG} ."
      }
    }

    stage('Push Image') {
      steps {
        withDockerRegistry(credentialsId: 'docker') {
          sh "docker push ${DOCKER_HUB_REPO}:${IMAGE_TAG}"
        }
      }
    }

    stage('Connect to Existing EKS') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws']]) {
          sh """
            aws eks update-kubeconfig \
            --region ${AWS_REGION} \
            --name ${K8S_CLUSTER_NAME}
            kubectl get nodes
          """
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh """
          sed -i 's|IMAGE_TAG|${IMAGE_TAG}|g' k8s/deployment.yaml
          kubectl apply -f k8s/
        """
      }
    }
  }
}
