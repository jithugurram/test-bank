pipeline {
  agent any

  environment {
    DOCKER_HUB_REPO = 'jithendragurram/bank'
    AWS_REGION = 'eu-west-2'
    K8S_CLUSTER_NAME = 'Jithubank'
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        git 'https://github.com/jithugurram/bank.git'
      }
    }

    stage('Build Image') {
      steps {
        sh "docker build -t ${DOCKER_HUB_REPO}:${IMAGE_TAG} ."
      }
    }

    stage('Push Image to DockerHub') {
      steps {
        script {
          withDockerRegistry(
            credentialsId: 'docker',
            url: 'https://index.docker.io/v1/'
          ) {
            sh "docker push ${DOCKER_HUB_REPO}:${IMAGE_TAG}"
          }
        }
      }
    }

stage('Deploy to EKS') {
  steps {
    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws']]) {
      sh """
        aws eks update-kubeconfig \
          --region ${AWS_REGION} \
          --name ${K8S_CLUSTER_NAME}

        sed -i 's|IMAGE_TAG|${IMAGE_TAG}|g' k8/deployment.yaml
        kubectl apply -f k8/
        kubectl get pods
      """
    }
  }
}

    }
  }

